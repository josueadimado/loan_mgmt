{% extends "base.html" %}
{% load humanize %}

{% block title %}
Statement for {{ borrower.first_name }} {{ borrower.last_name }} — LoanWise
{% endblock %}

{% block extra_css %}
<style>
  /* Ensure Navbar is Visible on Screen */
  @media screen {
    nav.navbar, nav.navbar-expand-lg, nav.navbar-dark, nav.bg-primary, nav.shadow-sm, nav.fixed-top {
      display: block !important; /* Force navbar visibility on screen */
      visibility: visible !important; /* Ensure it’s not hidden */
      position: fixed !important; /* Match fixed-top */
      top: 0 !important; /* Ensure it’s at the top */
      width: 100% !important; /* Full width */
      z-index: 1000 !important; /* Ensure it’s above other elements */
    }
    body {
      padding-top: 56px !important; /* Ensure padding for fixed navbar */
    }
  }

  /* Original Styles */
  .statement-header {
    text-align: center;
    margin-bottom: 2rem;
  }
  .statement-section {
    margin-bottom: 2rem;
  }
  .statement-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 1rem;
  }
  .statement-table th, .statement-table td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
  }
  .statement-table th {
    background-color: #f2f2f2;
  }
  .summary-table {
    width: 50%;
    margin-top: 1rem;
  }
  .card-body p {
    margin-bottom: 0.5rem;
  }

  /* Print-Specific Styling */
  @media print {
    nav {
      display: none !important; /* Hide navbar when printing */
    }
    .no-print {
      display: none !important;
    }
    .page-break {
      page-break-before: always; /* Ensure sections start on new pages */
    }
    .statement-section {
      page-break-inside: avoid; /* Prevent sections from splitting across pages */
    }
    .statement-table {
      page-break-inside: auto; /* Allow tables to break if needed */
    }
    .statement-table tr {
      page-break-inside: avoid; /* Prevent table rows from splitting */
    }
    .card {
      border: 1px solid #000; /* Ensure borders are visible in print */
      box-shadow: none;
    }
    /* Hide browser-added elements like URLs and timestamps */
    @page {
      margin: 1cm; /* Ensure consistent margins */
    }
    @page :first {
      margin-top: 1cm;
    }
    @page {
      size: A4;
      margin: 1cm;
      @top-left { content: none; }
      @top-center { content: none; }
      @top-right { content: none; }
      @bottom-left { content: none; }
      @bottom-center { content: none; }
      @bottom-right { content: none; }
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container my-3">
  <!-- Statement Header -->
  <div class="statement-header">
    <h1>Loan Statement</h1>
    <h3>{{ borrower.first_name }} {{ borrower.last_name }}</h3>
    <p>Statement Date: {{ statement_date|date:"Y-m-d H:i" }}</p>
    {% if generated_by %}
      <p>Generated By: {{ generated_by.username }}</p>
    {% endif %}
  </div>

  <!-- Borrower Information -->
  <div class="statement-section">
    <div class="d-flex align-items-center mb-2">
      <svg class="fs-4 me-2" width="1em" height="1em" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
        <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/>
        <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z"/>
      </svg>
      <h6 class="mb-0">Borrower Information</h6>
    </div>
    <div class="card p-3">
      <p>
        <svg class="me-1" width="1em" height="1em" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
          <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"/>
        </svg>
        <strong>Name:</strong> {{ borrower.first_name }} {{ borrower.last_name }}
      </p>
      <p>
        <svg class="me-1" width="1em" height="1em" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
          <path d="M3.654 1.328a.678.678 0 0 0-.957 0l-2.326 2.326a.678.678 0 0 0 0 .957l8.01 8.01a.678.678 0 0 0 .957 0l2.326-2.326a.678.678 0 0 0 0-.957l-8.01-8.01zm.678.957l7.332 7.332-1.648 1.648L2.684 4.933l1.648-1.648z"/>
          <path fill-rule="evenodd" d="M13.5 1a.5.5 0 0 1 .5.5V3h1.5a.5.5 0 0 1 0 1H14v1.5a.5.5 0 0 1-1 0V4h-1.5a.5.5 0 0 1 0-1H13V1.5a.5.5 0 0 1 .5-.5z"/>
        </svg>
        <strong>Phone Number:</strong> {{ borrower.phone_number|default:"N/A" }}
      </p>
      <p>
        <svg class="me-1" width="1em" height="1em" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
          <path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1H2zm13 2.383-4.758 2.855L15 11.114v-5.73zm-.034 6.878L9.271 8.82 8 9.583 6.728 8.82l-5.694 3.44A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.74zM1 11.114l4.758-2.876L1 5.383v5.73z"/>
        </svg>
        <strong>Email:</strong> {{ borrower.email|default:"N/A" }}
      </p>
      <p>
        <svg class="me-1" width="1em" height="1em" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
          <path d="M12.166 8.94c-.524 1.062-1.234 2.12-1.96 3.07A31.493 31.493 0 0 1 8 14.58a31.481 31.481 0 0 1-2.206-2.57c-.726-.95-1.436-2.008-1.96-3.07C3.304 7.867 3 6.862 3 6a5 5 0 0 1 10 0c0 .862-.305 1.867-.834 2.94zM8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10z"/>
          <path d="M8 8a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm0-1a1 1 0 0 0 0-2 1 1 0 0 0 0 2z"/>
        </svg>
        <strong>Address:</strong> {{ borrower.address|default:"N/A" }}
      </p>
      <p>
        <svg class="me-1" width="1em" height="1em" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
          <path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/>
        </svg>
        <strong>Region:</strong> {{ borrower.get_region_display|default:"N/A" }}
      </p>
    </div>
  </div>

  <!-- Loan Summary -->
  <div class="statement-section">
    <div class="d-flex align-items-center mb-2">
      <svg class="fs-4 me-2" width="1em" height="1em" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
        <path d="M1 3a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1H1zm7 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/>
        <path d="M0 5a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H1a1 1 0 0 1-1-1V5zm3 0a2 2 0 0 1-2 2v4a2 2 0 0 1 2 2h10a2 2 0 0 1 2-2V7a2 2 0 0 1-2-2H3z"/>
      </svg>
      <h6 class="mb-0">Loan Summary</h6>
    </div>
    {% if loan_data %}
      <div class="card p-3">
        <table class="statement-table">
          <thead>
            <tr>
              <th>Loan ID</th>
              <th>Start Date</th>
              <th>Principal</th>
              <th>Interest Rate</th>
              <th>Total to Pay</th>
              <th>Total Paid</th>
              <th>Remaining</th>
            </tr>
          </thead>
          <tbody>
            {% for data in loan_data %}
              <tr>
                <td>{{ data.loan.id }}</td>
                <td>{{ data.start_date|date:"Y-m-d" }}</td>
                <td>{{ data.loan.currency }}{{ data.principal|floatformat:2|intcomma }}</td>
                <td>{{ data.interest_rate|floatformat:2 }}%</td>
                <td>{{ data.loan.currency }}{{ data.total_to_pay|floatformat:2|intcomma }}</td>
                <td>{{ data.loan.currency }}{{ data.total_paid|floatformat:2|intcomma }}</td>
                <td>{{ data.loan.currency }}{{ data.remaining|floatformat:2|intcomma }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>

        <!-- Summary Totals -->
        <table class="statement-table summary-table">
          <tr>
            <th>Total Borrowed:</th>
            <td>{{ loan_data.0.loan.currency }}{{ total_principal|floatformat:2|intcomma }}</td>
          </tr>
          <tr>
            <th>Total Interest:</th>
            <td>{{ loan_data.0.loan.currency }}{{ total_interest|floatformat:2|intcomma }}</td>
          </tr>
          <tr>
            <th>Total to Pay:</th>
            <td>{{ loan_data.0.loan.currency }}{{ total_to_pay|floatformat:2|intcomma }}</td>
          </tr>
          <tr>
            <th>Total Paid:</th>
            <td>{{ loan_data.0.loan.currency }}{{ total_paid|floatformat:2|intcomma }}</td>
          </tr>
          <tr>
            <th>Total Remaining:</th>
            <td>{{ loan_data.0.loan.currency }}{{ total_remaining|floatformat:2|intcomma }}</td>
          </tr>
        </table>
      </div>
    {% else %}
      <div class="card p-3">
        <p>No loans found for this borrower.</p>
      </div>
    {% endif %}
  </div>

  <!-- Transaction History -->
  {% if loan_data %}
    <div class="statement-section">
      <div class="d-flex align-items-center mb-2">
        <svg class="fs-4 me-2" width="1em" height="1em" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
          <path d="M8.515 1.019A7 7 0 0 0 8 1V0a8 8 0 0 1 .589.022l-.074.997zm2.004.45a7.003 7.003 0 0 0-.985-.299l.219-.976c.383.086.76.2 1.126.342l-.36.933zm1.37.71a7.01 7.01 0 0 0-.439-.27l.493-.87a8.025 8.025 0 0 1 .979.654l-.615.789a6.996 6.996 0 0 0-.418-.302zm1.834 1.79a6.99 6.99 0 0 0-.653-.796l.724-.69c.27.285.52.59.747.91l-.818.576zm.744 1.352a7.08 7.08 0 0 0-.214-.468l.893-.45a7.976 7.976 0 0 1 .45 1.088l-.95.313a7.023 7.023 0 0 0-.179-.483zm.53 2.507a6.991 6.991 0 0 0-.1-.482l.966-.258c.068.375.104.756.104 1.14v.02h-1v-.02a6.996 6.996 0 0 0-.07-.458zM8 16a8 8 0 1 1 0-16 8 8 0 0 1 0 16zm0-1a7 7 0 1 0 0-14 7 7 0 0 0 0 14zm0-10V7h2v1H9v3H8v-3z"/>
        </svg>
        <h6 class="mb-0">Transaction History</h6>
      </div>
      {% for data in loan_data %}
        <div class="card p-3 mb-3">
          <h6 class="mb-3">Loan #{{ data.loan.id }} (Started {{ data.start_date|date:"Y-m-d" }})</h6>
          {% if data.repayments_with_balances %}
            <table class="statement-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Description</th>
                  <th>Amount</th>
                  <th>Balance</th>
                </tr>
              </thead>
              <tbody>
                <!-- Initial Loan Issuance -->
                <tr>
                  <td>{{ data.start_date|date:"Y-m-d" }}</td>
                  <td>Issued</td>
                  <td>+{{ data.loan.currency }}{{ data.principal|floatformat:2|intcomma }}</td>
                  <td>{{ data.loan.currency }}{{ data.principal|floatformat:2|intcomma }}</td>
                </tr>
                <!-- Repayments -->
                {% for entry in data.repayments_with_balances %}
                  <tr>
                    <td>{{ entry.repayment.date|date:"Y-m-d" }}</td>
                    <td>Payment</td>
                    <td>-{{ data.loan.currency }}{{ entry.repayment.amount|floatformat:2|intcomma }}</td>
                    <td>{{ data.loan.currency }}{{ entry.balance|floatformat:2|intcomma }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% else %}
            <p>No repayments recorded for this loan.</p>
          {% endif %}
        </div>
        {% if not forloop.last %}
          <div class="page-break"></div>
        {% endif %}
      {% endfor %}
    </div>
  {% endif %}

  <!-- Action Buttons -->
  <div class="text-center no-print">
    <button onclick="window.print()" class="btn btn-success me-2">
      <svg class="me-1" width="1em" height="1em" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
        <path d="M2.5 8a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1z"/>
        <path d="M5 1a2 2 0 0 0-2 2v2H2a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1v1a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h1a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-1V3a2 2 0 0 0-2-2H5zM4 3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v2H4V3zm1 5a2 2 0 0 0-2 2v1H2a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v-1a2 2 0 0 0-2-2H5zm7 2v3a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1z"/>
      </svg>
      Print Statement
    </button>
    <a href="?download=1" class="btn btn-primary me-2">
      <svg class="me-1" width="1em" height="1em" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
        <path d="M8.5 6.5a.5.5 0 0 0-1 0v3.793L6.354 9.146a.5.5 0 1 0-.708.708l2 2a.5.5 0 0 0 .708 0l2-2a.5.5 0 0 0-.708-.708L8.5 10.293V6.5z"/>
        <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/>
      </svg>
      Download PDF
    </a>
    <a href="{% url 'borrowers:borrower-detail' borrower.id %}" class="btn btn-outline-secondary">
      <svg class="me-1" width="1em" height="1em" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
        <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5.5H2.707l3.147 3.146a.5.5 0 0 1-.708.708l-4-4a.5.5 0 0 1 0-.708l4-4a.5.5 0 0 1 .708.708L2.707 7.5H14.5A.5.5 0 0 0 15 8z"/>
      </svg>
      Back to Borrower Details
    </a>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    {% if auto_print %}
      window.print();
    {% endif %}
  });
</script>
{% endblock %}