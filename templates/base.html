{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{% block title %}LoanMgmt{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    rel="stylesheet"
  >

  <!-- intl-tel-input CSS -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.css"
  />

  <!-- Bootstrap Select CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/css/bootstrap-select.min.css"
  />

  <!-- Custom styles -->
  <style>
    /* Loader styles */
    .loader-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      z-index: 2000;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .loader-overlay.hidden {
      display: none;
    }

    /* Sidebar styles */
    .sidebar {
      position: fixed;
      top: 56px; /* Height of the top header */
      bottom: 0;
      left: 0;
      z-index: 1000;
      width: 250px;
      padding-top: 1rem;
      background-color: #f8f9fa;
      border-right: 1px solid #dee2e6;
      overflow-y: auto;
      transition: transform 0.3s ease-in-out;
    }
    .sidebar .nav-link {
      color: #333;
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      border-radius: 0.25rem;
      margin: 0 0.5rem;
    }
    .sidebar .nav-link:hover {
      background-color: #e9ecef;
    }
    .sidebar .nav-link.active {
      background-color: #0d6efd;
      color: #fff;
      font-weight: 500;
    }
    .sidebar .nav-link i {
      font-size: 1.2rem;
    }
    .sidebar .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 1rem 1rem 1rem;
      border-bottom: 1px solid #dee2e6;
      margin-bottom: 1rem;
    }
    .sidebar .close-sidebar-btn {
      font-size: 1.5rem;
      color: #333;
      background: none;
      border: none;
      cursor: pointer;
    }
    .sidebar .close-sidebar-btn:hover {
      color: #0d6efd;
    }

    /* Main content adjustment */
    .main-content {
      margin-left: 250px; /* Width of sidebar */
      padding: 2rem;
      transition: margin-left 0.3s ease-in-out;
    }

    /* Top header styles */
    .top-header {
      background-color: #0d6efd;
      color: #fff;
      height: 56px;
      padding: 0 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1050;
    }
    .top-header .header-left {
      display: flex;
      align-items: center;
      gap: 0.75rem; /* Space between hamburger and logo */
    }
    .top-header .navbar-brand {
      color: #fff;
      font-weight: 600;
    }
    .top-header .navbar-brand:hover {
      color: #fff;
    }
    .top-header .user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .top-header .btn-outline-light {
      color: #fff;
      border-color: #fff;
    }
    .top-header .btn-outline-light:hover {
      background-color: #fff;
      color: #0d6efd;
    }
    .top-header .open-sidebar-btn {
      display: none; /* Hidden by default, shown when sidebar is closed */
      padding: 0.25rem 0.5rem; /* Smaller padding for better fit */
      background-color: rgba(255, 255, 255, 0.2); /* Slightly transparent background */
      border: none;
    }
    .top-header .open-sidebar-btn:hover {
      background-color: rgba(255, 255, 255, 0.3);
    }
    .top-header .open-sidebar-btn i {
      color: #fff;
      font-size: 1.2rem;
    }

    /* Ensure labels and inputs are aligned */
    .form-label {
      margin-bottom: 0.25rem;
      font-weight: 500;
    }
    .required-asterisk {
      color: #dc3545; /* Bootstrap danger color */
    }
    .form-section-heading {
      font-size: 1.1rem;
      font-weight: 600;
      margin-top: 1.5rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    /* Ensure Bootstrap Select dropdowns have sufficient z-index */
    .bootstrap-select .dropdown-menu {
      z-index: 1050;
    }
    /* Adjust body padding for fixed header */
    body {
      padding-top: 56px;
    }

    /* Sidebar and content adjustments when closed */
    body.sidebar-closed .sidebar {
      transform: translateX(-250px);
    }
    body.sidebar-closed .main-content {
      margin-left: 0;
    }
    body.sidebar-closed .open-sidebar-btn {
      display: block !important; /* Ensure visibility when sidebar is closed */
    }

    /* Responsive adjustments */
    @media (max-width: 991.98px) {
      .sidebar {
        transform: translateX(-250px); /* Hidden by default on small screens */
      }
      body:not(.sidebar-closed) .sidebar {
        transform: translateX(0); /* Show sidebar if not closed */
      }
      .main-content {
        margin-left: 0;
      }
    }
  </style>

  <!-- Your custom styles -->
  <link href="{% static 'css/style.css' %}" rel="stylesheet">

  {% block extra_css %}{% endblock %}
</head>
<body class="bg-light {% if not user.is_authenticated %}sidebar-closed{% endif %}">

  <!-- LOADER -->
  <div class="loader-overlay" id="loader">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- TOP HEADER -->
  <header class="top-header">
    <div class="header-left">
      <button class="btn open-sidebar-btn" type="button" id="sidebarToggle" aria-expanded="false" aria-controls="sidebar">
        <i class="bi bi-list"></i>
      </button>
      <a class="navbar-brand" href="{% url 'dashboard' %}">LoanMgmt</a>
    </div>
    <div class="user-info">
      {% if user.is_authenticated %}
        <span>Welcome, {{ user.get_full_name|default:user.username }}</span>
        <a class="btn btn-outline-light btn-sm" href="{% url 'logout' %}">Logout</a>
      {% else %}
        <a class="btn btn-outline-light btn-sm" href="{% url 'login' %}">Login</a>
      {% endif %}
    </div>
  </header>

  <!-- SIDEBAR -->
  {% if user.is_authenticated %}
    <nav class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <span class="ms-2 fw-bold">Menu</span>
        <button class="close-sidebar-btn" id="closeSidebarBtn" aria-label="Close sidebar">
          <i class="bi bi-x"></i>
        </button>
      </div>
      <ul class="nav flex-column">
        <li class="nav-item">
          <a class="nav-link {% if request.path == '/' %}active{% endif %}" href="{% url 'dashboard' %}">
            <i class="bi bi-house"></i> Dashboard
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if 'borrowers' in request.path %}active{% endif %}" href="{% url 'borrowers:borrower-list' %}">
            <i class="bi bi-person"></i> Borrowers
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if 'investors' in request.path %}active{% endif %}" href="{% url 'investors:investor-list' %}">
            <i class="bi bi-wallet"></i> Investors
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if 'loans' in request.path %}active{% endif %}" href="{% url 'loans:loan-list' %}">
            <i class="bi bi-cash-stack"></i> Loans
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if 'repayments' in request.path %}active{% endif %}" href="{% url 'repayments:repayment-list' %}">
            <i class="bi bi-receipt"></i> Repayments
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if 'users' in request.path %}active{% endif %}" href="{% url 'users:settings' %}">
            <i class="bi bi-gear"></i> Settings
          </a>
        </li>
      </ul>
    </nav>
  {% endif %}

  <!-- MAIN CONTENT -->
  <main class="main-content" id="mainContent">
    {% if messages %}
      {% for msg in messages %}
        <div class="alert alert-{% if msg.tags == 'success' %}success{% elif msg.tags == 'error' %}danger{% else %}{{ msg.tags }}{% endif %} alert-dismissible fade show">
          {{ msg }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endif %}
    {% block content %}{% endblock %}
  </main>

  <!-- jQuery (required for Bootstrap Select) -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <!-- intl-tel-input JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>
  <!-- Bootstrap Select JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/bootstrap-select.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function(){
      // Loader functionality with delay
      const loader = document.getElementById('loader');
      // Show loader on page load
      loader.classList.remove('hidden');

      // Hide loader after a delay when page is fully loaded
      window.addEventListener('load', function() {
        setTimeout(function() {
          loader.classList.add('hidden');
        }, 2000); // 2-second delay
      });

      // Sidebar toggle functionality
      const sidebar = document.getElementById('sidebar');
      const mainContent = document.getElementById('mainContent');
      const sidebarToggle = document.getElementById('sidebarToggle');
      const closeSidebarBtn = document.getElementById('closeSidebarBtn');
      const body = document.body;

      // Function to toggle sidebar visibility
      function toggleSidebar() {
        body.classList.toggle('sidebar-closed');
        // Update aria-expanded attribute for accessibility
        const isOpen = !body.classList.contains('sidebar-closed');
        sidebarToggle.setAttribute('aria-expanded', isOpen);
      }

      // Toggle sidebar on hamburger click (all screen sizes)
      if (sidebarToggle) {
        sidebarToggle.addEventListener('click', toggleSidebar);
      }

      // Close sidebar on close button click (all screen sizes)
      if (closeSidebarBtn) {
        closeSidebarBtn.addEventListener('click', toggleSidebar);
      }

      // Initialize intl-tel-input on phone inputs
      const inputs = document.querySelectorAll('input.phone-input');
      console.log('Found inputs for intl-tel-input:', inputs.length, inputs);
      const itiInstances = {};

      // Ensure utils.js is loaded before proceeding
      const utilsScript = 'https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js';
      const script = document.createElement('script');
      script.src = utilsScript;
      script.async = false; // Ensure synchronous loading for validation
      document.head.appendChild(script);

      script.onload = function() {
        console.log('intl-tel-input utils.js loaded successfully.');

        inputs.forEach(function(input){
          const iti = intlTelInput(input, {
            initialCountry: 'gh', // Default to Ghana
            separateDialCode: true,
            nationalMode: false, // Ensure E.164 format
            hiddenInput: null, // Prevent creation of hidden input
            utilsScript: utilsScript,
          });
          itiInstances[input.name] = iti;

          // Log the parent container after initialization
          const parent = input.parentElement;
          console.log('Phone input container after intl-tel-input init:', parent.innerHTML);

          // Add real-time validation on input change
          input.addEventListener('input', function() {
            validatePhoneInput(input, iti);
          });
          input.addEventListener('countrychange', function() {
            validatePhoneInput(input, iti);
          });
        });

        // Clean phone inputs on form submission
        const forms = document.querySelectorAll('form[id="borrower-form"], form[id="loan-form"]');
        forms.forEach(form => {
          form.addEventListener('submit', function(event){
            let allValid = true;

            form.querySelectorAll('input.phone-input').forEach(input => {
              const iti = itiInstances[input.name];
              if (!iti) {
                console.error('intl-tel-input instance not found for input:', input.name);
                allValid = false;
                return;
              }

              let value = iti.getNumber(); // Returns E.164 format (e.g., +233598158589)

              // Get the original value from the hidden field (only present in edit mode)
              const originalField = form.querySelector(`input[name="original_${input.name}"]`);
              const originalValue = originalField ? originalField.value : '';

              console.log('Phone input:', input.name, 'Submitted value (E.164):', value, 'Original value:', originalValue);
              console.log('Selected country:', iti.getSelectedCountryData());

              // Validate the phone number
              const isValid = iti.isValidNumber();
              if (!value) {
                // If the field is empty, set it to an empty string
                input.value = '';
                console.log('Phone input is empty:', input.name);
                // Check if the field is required
                if (input.hasAttribute('required')) {
                  allValid = false;
                  input.classList.add('is-invalid');
                  let errorDiv = input.nextElementSibling;
                  if (!errorDiv || !errorDiv.classList.contains('invalid-feedback')) {
                    errorDiv = document.createElement('div');
                    errorDiv.className = 'invalid-feedback';
                    input.parentNode.appendChild(errorDiv);
                  }
                  errorDiv.textContent = 'This field is required.';
                }
              } else if (!isValid) {
                console.error('Invalid phone number for country:', input.name, value, 'Country:', iti.getSelectedCountryData().name);
                allValid = false;
                input.classList.add('is-invalid');
                let errorDiv = input.nextElementSibling;
                if (!errorDiv || !errorDiv.classList.contains('invalid-feedback')) {
                  errorDiv = document.createElement('div');
                  errorDiv.className = 'invalid-feedback';
                  input.parentNode.appendChild(errorDiv);
                }
                errorDiv.textContent = 'Enter a valid phone number for the selected country (e.g., +233511287583 for Ghana, +22891234567 for Togo).';
              } else {
                // If valid, update the input value
                input.value = value;
                console.log('Cleaned phone input:', input.name, value);
                // Remove any error styling
                input.classList.remove('is-invalid');
                const errorDiv = input.nextElementSibling;
                if (errorDiv && errorDiv.classList.contains('invalid-feedback')) {
                  errorDiv.textContent = '';
                }
              }

              // If the value hasn't changed (exact match), preserve the original
              if (value === originalValue && originalValue) {
                console.log('Phone input unchanged (exact match), preserving original:', input.name, originalValue);
                input.value = originalValue;
                return;
              }

              // Normalize both values for comparison (in case of formatting differences)
              const normalizedValue = value ? value.replace(/\D/g, '') : '';
              const normalizedOriginal = originalValue ? originalValue.replace(/\D/g, '') : '';
              if (normalizedValue === normalizedOriginal && originalValue) {
                console.log('Phone input unchanged (normalized match), preserving original:', input.name, originalValue);
                input.value = originalValue;
                return;
              }
            });

            if (!allValid) {
              event.preventDefault();
              event.stopPropagation();
              console.log('Form submission prevented due to invalid phone numbers.');
              // Ensure Bootstrap validation styles are applied
              form.classList.add('was-validated');
            } else {
              // Log all form data before submission
              const formData = new FormData(form);
              const formEntries = Object.fromEntries(formData.entries());
              console.log('Form data before submission:', formEntries);
            }
          }, { once: true });
        });
      };

      script.onerror = function() {
        console.error('Failed to load intl-tel-input utils.js. Validation may not work.');
      };

      function validatePhoneInput(input, iti) {
        let value = iti.getNumber();
        const isValid = iti.isValidNumber();
        if (!value) {
          if (input.hasAttribute('required')) {
            input.classList.add('is-invalid');
            let errorDiv = input.nextElementSibling;
            if (!errorDiv || !errorDiv.classList.contains('invalid-feedback')) {
              errorDiv = document.createElement('div');
              errorDiv.className = 'invalid-feedback';
              input.parentNode.appendChild(errorDiv);
            }
            errorDiv.textContent = 'This field is required.';
          }
        } else if (!isValid) {
          input.classList.add('is-invalid');
          let errorDiv = input.nextElementSibling;
          if (!errorDiv || !errorDiv.classList.contains('invalid-feedback')) {
            errorDiv = document.createElement('div');
            errorDiv.className = 'invalid-feedback';
            input.parentNode.appendChild(errorDiv);
          }
          errorDiv.textContent = 'Enter a valid phone number for the selected country (e.g., +233511287583 for Ghana, +22891234567 for Togo).';
        } else {
          input.classList.remove('is-invalid');
          const errorDiv = input.nextElementSibling;
          if (errorDiv && errorDiv.classList.contains('invalid-feedback')) {
            errorDiv.textContent = '';
          }
        }
      }
    });
  </script>

  {% block extra_js %}{% endblock %}
</body>
</html>